---
title: "Process_MRMS"
author: "Megan Sears"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(raster)
library(rgdal)
library(sf)
library(sp)
library(mapview)
library(terra)
library(tmap)
library(readr)


```

```{r}
# #unzip all files, first list all files **ALREADY COMPLETE**
# zip <- list.files(path = 'E:/MRMS', pattern = '.gz',
#                   full.names = T)
# 
# #unzip all listed files
# test <- lapply(zip, gunzip)

filename <- list.file(path = 'E:/MRMS', pattern = '.grib2')

#pull in an example raster
r <- rast('E:/MRMS/RadarOnly_QPE_01H_00.00_20220716-000000.grib2') %>%
  terra::project(., 'EPSG:26913')

#bennett polygons
ben <- vect('GIS/mulch_study_watersheds.shp') %>%
  terra::project(., 'EPSG:26913')

#cpf polygon
cpf <- vect('GIS/cameron_boundary.shp') %>%
  terra::project(., 'EPSG:26913')

# CODE BELOW IS OLD
# #crs(r) == crs(cpf)
# 
# #crop raster to cpf
# crop <- terra::crop(r, ext(cpf))
# 
# names(crop) <- 'p_mmhr'
# 
# #only converting this to raster layer and SP  df for mapview
# #ben1 <- as(ben, "Spatial")
# #crop1 <- raster(crop)
# 
# #mapview(ben1) + mapview(crop1) 
# 
# #extract using terra bc it has more functions :)
# extract <- terra::extract(crop, ben, fun = mean, touches = T, exact = T)
# extract$name <- ben$ID
# 
# extract
# 
# filename <- 'RadarOnly_QPE_01H_00.00_20220716-000000.grib2'
# timestamp <- substr(filename, 25, 39)
# 
# extract <- extract %>%
#   mutate(datetime = ymd_hms(timestamp)) %>%
#   mutate(datetime = datetime - (6 * 60 * 60)) %>%
#   mutate(doy = yday(datetime)) %>%
#   mutate(hour = hour(datetime))
# 
# write.csv(extract, paste0('extract_', extract$doy[1],'_', extract$hour[1],'.csv'))

```



```{r make it a function}
setwd('E:/MRMS_2022')

filenames <- list.files(".", pattern='.grib2', full.names=F)

#extract_MRMS <- function() {
  
  for(fileName in filenames) {

#pull in raster
r <- rast(fileName) %>%
  terra::project(., 'EPSG:26913')
   
#crop raster to cpf
crop <- terra::crop(r, ext(cpf))

names(crop) <- 'p_mmhr'    

#extract using terra bc it has more functions :)
extract <- terra::extract(crop, ben, fun = mean, touches = T, exact = T)
extract$name <- ben$ID
    
timestamp <- substr(fileName, 25, 39)

extract <- extract %>%
  mutate(datetime = ymd_hms(timestamp)) %>%
  mutate(datetime = datetime - (6 * 60 * 60)) %>%
  mutate(doy = yday(datetime)) %>%
  mutate(hour = hour(datetime))

write.csv(extract, paste0('extract_', extract$doy[1],'_', extract$hour[1],'.csv'))

  }

```

```{r compile all CSVs}

#compile all CSVs
mrms_21 <- list.files(path='./MRMS_data/2021', full.names = T) %>% 
  lapply(read_csv) %>% 
  bind_rows 

mrms_22 <- list.files(path='./MRMS_data/2022', full.names = T) %>% 
  lapply(read_csv) %>% 
  bind_rows 

#remove random columns
mrms_21 <- mrms_21 %>%
  dplyr::select(-c(doy, hour))

mrms_22 <- mrms_22 %>%
  dplyr::select(-c(...1, ID, doy, hour))

```

```{r get events and MI60 from MRMS}





```

