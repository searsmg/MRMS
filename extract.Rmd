---
title: "Comparing MRMS and Tipping Buckets"
author: "Megan Sears"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: journal
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      fig.width = 12,
                      fig.height = 6)

library(tidyverse)
library(lubridate)
library(raster)
library(rgdal)
library(sf)
library(sp)
library(mapview)
library(terra)
library(tmap)
library(readr)
library(gridExtra)
library(ggplot2); theme_set(theme_bw(base_size = 16))
library(here)
library(irr)
library(plotly)
library(kableExtra)
library(tmap)
library(pscl)
library(caret)
library(scales)

```

```{r}
# #unzip all files, first list all files **ALREADY COMPLETE**
# zip <- list.files(path = 'E:/MRMS', pattern = '.gz',
#                   full.names = T)
# 
# #unzip all listed files
# test <- lapply(zip, gunzip)

# filename <- list.file(path = 'E:/MRMS', pattern = '.grib2')
# 
# #pull in an example raster
# r <- rast('E:/MRMS/RadarOnly_QPE_01H_00.00_20220716-000000.grib2') %>%
#   terra::project(., 'EPSG:26913')
#
# #bennett polygons
# ben <- vect('GIS/mulch_study_watersheds.shp') %>%
#   terra::project(., 'EPSG:26913')
#
# #cpf polygon
# cpf <- vect('GIS/cameron_boundary.shp') %>%
#   terra::project(., 'EPSG:26913')

# CODE BELOW IS OLD
# #crs(r) == crs(cpf)
#
# #crop raster to cpf
# crop <- terra::crop(r, ext(cpf))
#
# names(crop) <- 'p_mmhr'
#
# #only converting this to raster layer and SP  df for mapview
# #ben1 <- as(ben, "Spatial")
# #crop1 <- raster(crop)
#
# #mapview(ben1) + mapview(crop1)
#
# #extract using terra bc it has more functions :)
# extract <- terra::extract(crop, ben, fun = mean, touches = T, exact = T)
# extract$name <- ben$ID
#
# extract
# 
# filename <- 'RadarOnly_QPE_01H_00.00_20220716-000000.grib2'
# timestamp <- substr(filename, 25, 39)
# 
# extract <- extract %>%
#   mutate(datetime = ymd_hms(timestamp)) %>%
#   mutate(datetime = datetime - (6 * 60 * 60)) %>%
#   mutate(doy = yday(datetime)) %>%
#   mutate(hour = hour(datetime))
# 
# write.csv(extract, paste0('extract_', extract$doy[1],'_', extract$hour[1],'.csv'))

```

```{r make it a function}
# setwd('E:/MRMS_2022')
# 
# filenames <- list.files(".", pattern='.grib2', full.names=F)
# 
# #extract_MRMS <- function() {
#   
#   for(fileName in filenames) {
# 
# #pull in raster
# r <- rast(fileName) %>%
#   terra::project(., 'EPSG:26913')
#    
# #crop raster to cpf
# crop <- terra::crop(r, ext(cpf))
# 
# names(crop) <- 'p_mmhr'    
# 
# #extract using terra bc it has more functions :)
# extract <- terra::extract(crop, ben, fun = mean, touches = T, exact = T)
# extract$name <- ben$ID
#     
# timestamp <- substr(fileName, 25, 39)
# 
# extract <- extract %>%
#   mutate(datetime = ymd_hms(timestamp)) %>%
#   mutate(datetime = datetime - (6 * 60 * 60)) %>%
#   mutate(doy = yday(datetime)) %>%
#   mutate(hour = hour(datetime))
# 
# write.csv(extract, paste0('extract_', extract$doy[1],'_', extract$hour[1],'.csv'))
# 
#   }

```

```{r compile all CSVs}

#compile all CSVs
# mrms_21 <- list.files(path='./MRMS_data/2021', full.names = T) %>% 
#   lapply(read_csv) %>% 
#   bind_rows 
# 
# mrms_22 <- list.files(path='./MRMS_data/2022', full.names = T) %>% 
#   lapply(read_csv) %>% 
#   bind_rows 
# 
# #remove random columns
# mrms_21 <- mrms_21 %>%
#   dplyr::select(-c(doy, hour))
# 
# mrms_22 <- mrms_22 %>%
#   dplyr::select(-c(...1, ID, doy, hour))
# 
# write_csv(mrms_21, 'mrms_21.csv')
# write_csv(mrms_22, 'mrms_22.csv')

```

# Rainfall

## Cumulative rainfall from TB vs MRMS

```{r get hourly tip bucket}

#bring in tb and sum as hourly
tip <- read_csv('bennett_rain_TB.csv') %>% 
  mutate(hour = hour(datetime),
         datetime = ymd_hm(datetime),
         date = as.Date(datetime)) %>%
  group_by(site, date, hour) %>%
  summarize(hr_p_mm = sum(precip_mm)) %>%
  mutate(datetime = ymd_h(paste(date, hour))) %>%
  filter(datetime > '2021-07-19 23:00') %>%
  ungroup() %>%
  dplyr::select(-c(date, hour)) %>%
  rename(p_mmhr = hr_p_mm) %>%
  mutate(source = 'tb')

#bring in mrms hourly  
mrms21 <- read_csv('mrms_21.csv') %>%
  dplyr::select(-c(...1, ID)) %>%
  rename(site = name) %>%
  mutate(site = tolower(site)) %>%
  mutate(datetime  = datetime - (1 * 60 * 60)) #should only be -1, figure out time correction

mrms22 <- read_csv('mrms_22.csv') %>%
  rename(site = name) %>%
  mutate(site = tolower(site)) %>%
  mutate(datetime  = datetime - (1 * 60 * 60)) #should only be -1, figure out time correction

mrms <- bind_rows(mrms21, mrms22) %>%
  mutate(source = 'mrms')

#bind together mrms and tb
all <- bind_rows(mrms, tip) %>%
  mutate(year = year(datetime)) %>%
  group_by(source, year, site) %>%
  mutate(cump = cumsum(p_mmhr)) %>%
  ungroup() %>%
  arrange(datetime)

# ggplotly to find events where there are MRMS and not TB
{all %>%
  filter(site == 'ue',
         year == 2022) %>%
  ggplot(aes(datetime, p_mmhr, color = source)) + 
  geom_line() +
  geom_point(size = 1.5) +
  labs(x = 'Date',
       y = 'p_mmhr')} %>%
  ggplotly()

#2021
all21 <- filter(all, year == 2021)

ggplot(all21, aes(datetime, cump, color = source)) + 
  geom_line() +
  facet_wrap(~site) +
  ggtitle('2021') +
  labs(x = 'Date',
       y = 'Cumulative summer rain (mm)')

#2022
all22 <- filter(all, year == 2022)

ggplot(all22, aes(datetime, cump, color = source)) + 
  geom_line() +
  facet_wrap(~site, scales = 'free')  +
  ggtitle('2022') +
  labs(x = 'Date',
       y = 'Cumulative summer rain (mm)')

```

## Comparing daily TB and MRMS

```{r compare daily}
all_daily <- all %>%
  mutate(date = as.Date(datetime)) %>%
  group_by(date, site, source) %>%
  summarize(p_mmday = sum(p_mmhr)) %>%
  ungroup() %>% 
  pivot_wider(id_cols = c(date, site), names_from = 'source', values_from = 'p_mmday')

daily_filter <- all_daily %>%
  mutate(check = if_else(mrms > 1 & is.na(tb), 1, 0)) %>%
  filter(check == 1,
         date > '2021-07-19') %>%
  group_by(date) %>%
  mutate(sitecheck = sum(check)) %>%
  filter(sitecheck == 6)
```

In summary, there are 18 total instances where there is MRMS data recorded in a day, but no tipping bucket data. For each of those instances, I pulled the stage response to see if there was a response and at what sites. There was no case where there was MRMS rainfall in a day with no stage response at one or more of the sites. For each of the dates listed above, if a site is not listed, then it either did not respond to the MRMS rain or rain amount was 0 or <1. 

2021-7-22: response of 3   at uw 

2021-8-14: response of 3-30   at uw, me (30 here), ue 

2021-10-27: response of 7 & 44   at uw and um, respectively 

2022-5-1: response of 3-16   at mm, mw, um 

2022-5-2: same as above (storm stretches from May 1 to May 2) 

2022-5-3: response of 5-24   at mw, um, mm, ue  

2022-5-4: same as above (storm stretches from May 3 to May 4) 

2022-5-17: response of 3 and 18   for uw and me, respectively 

2022-6-3: response of 3-16   me, mm, and uw 

2022-6-14: response of 5-24   at me, mm, ue 

2022-6-27: response of 3-15   at me, mm, ue, up 

2022-7-30: response of 7-19   at ue, um, uw 

2022-7-31: response of 3-39   at all sites 

2022-8-12: response of 5-32   at me, mw, ue, um, uw 

2022-8-23: response of 3-37   at mm, mw, ue, um, uw 

2022-10-23: response of 10-22 at ue and um (some cap rods had already been downloaded for season) 

2022-10-26: response of 5-13 at ue and um (some cap rods had already been downloaded for season) 

2022-10-27: (after all cap rods had been downloaded for the season) 

## MRMS spatial pattern for events when no TB was recorded

```{r more mrms spatial}

# bennett polygons - only bring in once
ben <- vect('GIS/mulch_study_watersheds.shp') %>%
   terra::project(., 'EPSG:26913')

ben1 <- as(ben, "Spatial")

#cpf polygon - only  bring in once
cpf <- vect('GIS/cameron_boundary.shp') %>%
   terra::project(., 'EPSG:26913')

sensors <- read_csv('GIS/benn_sensors.csv') %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326)

ben_bound <- st_bbox(ben1)

# ##############################################
# 2022-08-23 event
#pull in an example raster -- add 7 hrs
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220823-220000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop <- terra::crop(r, ext(cpf))

names(crop) <- 'p_mmhr'

crop1 <- raster(crop) #only doing this for mapview purpose

tmap_mode('view')
aug23_22_13 <- tm_shape(crop1, bbox=ben_bound) +
  tm_raster(breaks = c(0,0.5,1,2.5,5,7.5,10),
            palette = "Set2") +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-08-23 @ 13:00',
              legend.outside = T)

# 2022-08-23 14:00
#pull in an example raster -- add 7 hrs
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220823-230000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop2 <- terra::crop(r, ext(cpf))

names(crop2) <- 'p_mmhr'

crop2 <- raster(crop2) #only doing this for mapview purpose


aug23_22_14 <- tm_shape(crop2, bbox=ben_bound) +
  tm_raster(breaks = c(0,0.5,2.5,5,7.5,10),
            palette = "Set2") +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-08-23 @ 14:00',
              legend.outside = T)

# 2022-08-23 15:00
#pull in an example raster -- add 7 hrs
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220824-000000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop3<- terra::crop(r, ext(cpf))

names(crop3) <- 'p_mmhr'

crop3 <- raster(crop3) #only doing this for mapview purpose


aug23_22_15 <- tm_shape(crop3, bbox=ben_bound) +
  tm_raster(breaks = c(0,0.5,2.5,5,7.5,10),
            palette = "Set2") +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-08-23 @ 15:00',
              legend.outside = T)


# 2022-08-23 16:00
#pull in an example raster -- add 7 hrs
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220824-010000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop4<- terra::crop(r, ext(cpf))

names(crop4) <- 'p_mmhr'

crop4 <- raster(crop4) #only doing this for mapview purpose


aug23_22_16 <- tm_shape(crop4, bbox=ben_bound) +
  tm_raster(breaks = c(0,0.5,2.5,5,7.5,10),
            palette = "Set2") +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-08-23 @ 16:00',
              legend.outside = T)


tmap_arrange(aug23_22_13, aug23_22_14, aug23_22_15, aug23_22_16)

# looking at 2022-07-31 from 11:00 to 15:00
#pull in an example raster -- add 7 hrs
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220731-180000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop5 <- terra::crop(r, ext(cpf))

names(crop5) <- 'p_mmhr'

crop5 <- raster(crop5) #only doing this for mapview purpose

jul7_22_11 <- tm_shape(crop5, bbox=ben_bound) +
  tm_raster(palette = "Set2",
            breaks = c(0,1,2,3,4,5)) +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-07-31 @ 11:00',
              legend.outside = T)

# 2022-07-31 12:00
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220731-190000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop6 <- terra::crop(r, ext(cpf))

names(crop6) <- 'p_mmhr'

crop6 <- raster(crop6) #only doing this for mapview purpose

jul7_22_12 <- tm_shape(crop6, bbox=ben_bound) +
  tm_raster(palette = "Set2",
            breaks = c(0,1,2,3,4,5)) +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-07-31 @ 12:00',
              legend.outside = T)


# 2022-07-31 13:00
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220731-200000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop7 <- terra::crop(r, ext(cpf))

names(crop7) <- 'p_mmhr'

crop7 <- raster(crop7) #only doing this for mapview purpose

jul7_22_13 <- tm_shape(crop7, bbox=ben_bound) +
  tm_raster(palette = "Set2",
            breaks = c(0,1,2,3,4,5)) +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-07-31 @ 13:00',
              legend.outside = T)


# 2022-07-31 14:00
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220731-210000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop8 <- terra::crop(r, ext(cpf))

names(crop8) <- 'p_mmhr'

crop8 <- raster(crop8) #only doing this for mapview purpose

jul7_22_14 <- tm_shape(crop8, bbox=ben_bound) +
  tm_raster(palette = "Set2",
            breaks = c(0,1,2,3,4,5)) +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-07-31 @ 14:00',
              legend.outside = T)


# 2022-07-31 15:00
r <- rast('/Users/megansears/Documents/MRMS/2022/RadarOnly_QPE_01H_00.00_20220731-220000.grib2') %>%
  terra::project(., 'EPSG:26913')

#crop raster to cpf
crop9 <- terra::crop(r, ext(cpf))

names(crop9) <- 'p_mmhr'

crop9 <- raster(crop9) #only doing this for mapview purpose

jul7_22_15 <- tm_shape(crop9, bbox=ben_bound) +
  tm_raster(palette = "Set2",
            breaks = c(0,1,2,3,4,5)) +
    tm_shape(ben1, bbox = ben_bound) +
  tm_polygons(alpha=0) +
    tm_shape(sensors) +
    tm_symbols(shape = 'Type') +
    tm_layout(main.title = '2022-07-31 @ 15:00',
              legend.outside = T)

tmap_mode('plot')
tmap_arrange(jul7_22_11, jul7_22_12, jul7_22_13, jul7_22_14, jul7_22_15)


```

## 1:1 for TB vs. MRMS

These data represent when the tipping bucket had a record.

```{r 1:1}
#compare the radar data when the TB has data
compare <- left_join(tip, mrms, by = c('datetime', 'site')) %>%
  mutate(year = year(datetime)) %>%
  rename(tb_rain_mm = p_mmhr.x,
         mrms_rain_mm = p_mmhr.y)

ggplot(compare, aes(tb_rain_mm, mrms_rain_mm)) + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  facet_wrap(~site, scales = 'free') +
  ggtitle('1:1 TB vs MRMS when there are TB events')

#cum sum of when there is tb tips
compare <- compare %>%
  arrange(datetime) %>%
  group_by(year, site) %>% 
  mutate(cum_tb_mm = cumsum(tb_rain_mm),
         cum_mrms_mm = cumsum(replace_na(mrms_rain_mm, 0)))

ggplot(compare, aes(x=datetime)) + 
  geom_line(aes(y=cum_tb_mm, color ='TB')) +
  geom_line(aes(y=cum_mrms_mm, color = 'MRMS')) +
  scale_x_datetime(date_labels = '%b', breaks = '1 month') +
  scale_color_manual(name="Source", values=c('TB' = 'orange',
                                            'MRMS'="purple")) +
  facet_wrap(~site + year, scales = 'free') +
  ggtitle('Cumulative sums when TB has events')

# #shift tb then compare
# tip_shift <- tip %>%
#   mutate(datetime = datetime + (1*60*60)) #just testing a theory
# 
# #compare when there are tb events to MRMS with a 1hr tb shift
# compare_tbshift <- left_join(tip_shift, mrms, by = c('datetime', 'site')) %>%
#   mutate(year = year(datetime)) %>%
#   rename(tb_rain_mm = p_mmhr.x,
#          mrms_rain_mm = p_mmhr.y) %>% 
#   arrange(datetime) %>%
#   group_by(year, site) %>% 
#   mutate(cum_tb_mm = cumsum(tb_rain_mm),
#          cum_mrms_mm = cumsum(replace_na(mrms_rain_mm, 0)))
# 
# ggplot(compare_tbshift, aes(tb_rain_mm, mrms_rain_mm)) + 
#   geom_point() +
#   geom_abline(intercept = 0, slope = 1, size=1, color='red') +
#   facet_wrap(~site, scales = 'free') +
#   ggtitle('1:1 w/ TB shift')
# 
# ggplot(compare_tbshift, aes(x=datetime)) + 
#   geom_line(aes(y=cum_tb_mm, color ='TB')) +
#   geom_line(aes(y=cum_mrms_mm, color = 'MRMS')) +
#   scale_x_datetime(date_labels = '%b', breaks = '1 month') +
#   scale_color_manual(name="Source", values=c('TB' = 'orange',
#                                             'MRMS'="purple")) +
#   facet_wrap(~site + year, scales = 'free') +
#   ggtitle('Cumulative sum when TB has events w/ a 1 hr tb shift')


# compare_full <- right_join(tip, mrms, by = c('datetime', 'site'))
# 
# ggplot(compare_full, aes(p_mmhr.x, p_mmhr.y)) + 
#   geom_point() +
#   geom_abline(intercept = 0, slope = 1, size=1, color='red') +
#   facet_wrap(~site, scales = 'free') 

```

## Compare precip events

A comparison between TB and MRMS for a few rainfall events.

```{r event compares}
#use this df to pick out some events - but use all df to look actually compare
tb_event <- read_csv("tb_events.csv") %>%
  mutate(source = 'tb',
         year = year(endtime)) %>%
  rename(end_time = endtime)

# 2022-08-15 event
event1 <- all %>%
  filter(between(datetime, ymd_hms('2022-08-15 11:00:00'),
                 ymd_hms('2022-08-15 20:00:00'))) %>%
  filter(site == 'me') %>%
  group_by(source) %>%
  mutate(cum_rain_mm = cumsum(p_mmhr))
  
event1_line <- event1 %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle('ME event: 2022-08-15 11:00 to 20:00') +
  theme_bw() +
    theme(legend.position = "none") +
  labs(x = 'Time',
       y = 'Rain (mm/hr)')

event1_cum <- event1 %>%
ggplot(aes(datetime, cum_rain_mm, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle(' ') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Cumulative rain (mm/hr)')

grid.arrange(event1_line, event1_cum, nrow = 1)

# 2022-07-15 event
event2 <- all %>%
  filter(between(datetime, ymd_hms('2022-07-15 15:00:00'),
                 ymd_hms('2022-07-16 01:00:00'))) %>%
  filter(site == 'ue') %>%
  group_by(source) %>%
  mutate(cum_rain_mm = cumsum(p_mmhr))
  
event2_line <- event2 %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle('UE event: 2022-07-15 16:00') +
  theme_bw() +
    theme(legend.position = "none") +
  labs(x = 'Time',
       y = 'Rain (mm/hr)')

event2_cum <- event2 %>%
ggplot(aes(datetime, cum_rain_mm, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle(' ') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Cumulative rain (mm/hr)')

grid.arrange(event2_line, event2_cum, nrow = 1)

#event example 3
event3 <- all %>%
  filter(between(datetime, ymd_hms('2021-08-03 09:00:00'),
                 ymd_hms('2021-08-03 23:00:00'))) %>%
  filter(site == 'me') %>%
  group_by(source) %>%
  mutate(cum_rain_mm = cumsum(p_mmhr))
  
event3_line <- event3 %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle('ME event: 2021-08-03 9:00 to 23:00') +
  theme_bw() +
    theme(legend.position = "none") +
  labs(x = 'Time',
       y = 'Rain (mm/hr)')

event3_cum <- event3 %>%
ggplot(aes(datetime, cum_rain_mm, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle(' ') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Cumulative rain (mm/hr)')

grid.arrange(event3_line, event3_cum, nrow = 1)

#event 4
event4 <- all %>%
  filter(between(datetime, ymd_hms('2021-08-03 09:00:00'),
                 ymd_hms('2021-08-03 20:00:00'))) %>%
  filter(site == 'uw') %>%
  group_by(source) %>%
  mutate(cum_rain_mm = cumsum(p_mmhr))
  
event4_line <- event4 %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle('UW event: 2021-08-03 09:00 to 20:00') +
  theme_bw() +
    theme(legend.position = "none") +
  labs(x = 'Time',
       y = 'Rain (mm/hr)')

event4_cum <- event4 %>%
ggplot(aes(datetime, cum_rain_mm, color = source, shape = source),
       size = 6) +
  geom_line() +
  ggtitle(' ') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Cumulative rain (mm/hr)')

grid.arrange(event4_line, event4_cum, nrow = 1)


```

## MRMS spatial patterns for above example events

```{r spatial examples}
#bennett polygons - only bring in once
# ben <- vect('GIS/mulch_study_watersheds.shp') %>%
#    terra::project(., 'EPSG:26913')
# 
# ben1 <- as(ben, "Spatial")
#  
# #cpf polygon - only  bring in once
# cpf <- vect('GIS/cameron_boundary.shp') %>%
#    terra::project(., 'EPSG:26913')
# ##############################################
# #event 1 from above 
# #pull in an example raster -- add 7 hrs
# r <- rast('E:/MRMS_2022/RadarOnly_QPE_01H_00.00_20220816-030000.grib2') %>%
#   terra::project(., 'EPSG:26913')
# 
# #crop raster to cpf
# crop <- terra::crop(r, ext(cpf))
#  
# names(crop) <- 'p_mmhr'
# 
# #crop1 <- raster(crop) #only doing this for mapview purposes
# 
# #mapview(ben1) + mapview(crop1)
# 
# #extract using terra bc it has more functions :)
# extract1_20 <- terra::extract(crop, ben, touches = T, exact = T) %>%
#   filter(ID == 1) %>%
#   mutate(datetime = '2022-08-15 20:00')
# 
# extract1_11 <- extract1_11 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_12 <- extract1_12 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_13 <- extract1_13 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_14 <- extract1_14 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_15 <- extract1_15 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_16 <- extract1_16 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_17 <- extract1_17 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_18 <- extract1_18 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_19 <- extract1_19 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1_20 <- extract1_20 %>%
#   rename(site = ID) %>%
#   mutate(site = 'me',
#          source = paste0('mrms',1:5))
# 
# extract1 <- bind_rows(extract1_11, extract1_12,
#                       extract1_13,extract1_14,
#                       extract1_15,extract1_16,
#                       extract1_17,extract1_18,
#                       extract1_19,extract1_20) %>%
#   dplyr::select(-fraction) %>%
#   mutate(datetime = ymd_hm(datetime))

## notice this data does not include the shift that is ALREADY included above
load('event1_spatial.Rdata') 

event1_spatial %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source)) +
  geom_line(size = 0.75) +
  geom_point(size = 4) +
  ggtitle('ME event: 2022-08-15 11:00 to 20:00') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Rain (mm/hr)') +
  scale_color_brewer(palette = "Dark2") +
  scale_x_datetime(breaks = '1 hour', date_labels = "%l %p")

#shift tb by an hour
event1_spatial_tbshift <- event1_spatial %>%
  mutate(datetime = if_else(source == 'tb', datetime + (1*60*60),
                          datetime)) #just testing a theory

event1_spatial_tbshift %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source)) +
  geom_line(size = 0.75) +
  geom_point(size = 4) +
  ggtitle('ME event: 2022-08-15 11:00 to 20:00 w/ TB shift') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Rain (mm/hr)') +
  scale_color_brewer(palette = "Dark2") +
  scale_x_datetime(breaks = '1 hour', date_labels = "%l %p")

#######################################################################

#TIME FOR EVENT 2
#pull in an example raster -- add 7 hrs
# r <- rast('E:/MRMS_2022/RadarOnly_QPE_01H_00.00_20220716-080000.grib2') %>%
#   terra::project(., 'EPSG:26913')
# 
# #crop raster to cpf
# crop <- terra::crop(r, ext(cpf))
#  
# names(crop) <- 'p_mmhr'
# 
# #extract using terra bc it has more functions :)
# extract2_01 <- terra::extract(crop, ben, touches = T, exact = T) %>%
#   filter(ID == 4) %>%
#   mutate(datetime = '2022-07-16 01:00')
# 
# extract2_15 <- extract2_15 %>%
#   rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4))
# 
# extract2_16 <- extract2_16 %>%
#   rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4))
# 
# extract2_17 <- extract2_17 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 17:00') 
# 
# extract2_18 <- extract2_18 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 18:00') 
# 
# extract2_19 <- extract2_19 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 19:00') 
# 
# extract2_20 <- extract2_20 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 20:00') 
# 
# extract2_21 <- extract2_21 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 21:00') 
# 
# extract2_22 <- extract2_22 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 22:00') 
# 
# extract2_23 <- extract2_23 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4),
#          datetime = '2022-07-15 23:00') 
# 
# extract2_00 <- extract2_00 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4))
# 
# extract2_01 <- extract2_01 %>%
#   #rename(site = ID) %>%
#   mutate(site = 'ue',
#          source = paste0('mrms',1:4))
# 
# extract2 <- bind_rows(extract2_15, extract2_16,
#                       extract2_17,extract2_18,
#                       extract2_19,extract2_20,
#                       extract2_21,extract2_22,
#                       extract2_23,extract2_00,
#                       extract2_01) %>%
#   dplyr::select(-fraction) %>%
#   mutate(datetime = ymd_hm(datetime))

## notice this data does not include the shift that is ALREADY included above
load('event2_spatial.Rdata')

event2_spatial %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source)) +
  geom_line(size = 0.75) +
  geom_point(size = 4) +
  ggtitle('UE event: 2022-07-15 15:00 to 07-16 01:00') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Rain (mm/hr)') +
  scale_color_brewer(palette = "Dark2") +
  scale_x_datetime(breaks = '1 hour', date_labels = "%l %p")

event2_spatial_tbshift <- event2_spatial %>%
  mutate(datetime = if_else(source == 'tb', datetime + (1*60*60),
                           datetime)) #just testing a theory
  
event2_spatial_tbshift %>%
ggplot(aes(datetime, p_mmhr, color = source, shape = source)) +
  geom_line(size = 0.75) +
  geom_point(size = 4) +
  ggtitle('UE event: 2022-07-15 15:00 to 07-16 01:00 w/ TB shift') +
  theme_bw() +
  labs(x = 'Time',
       y = 'Rain (mm/hr)') +
  scale_color_brewer(palette = "Dark2") +
  scale_x_datetime(breaks = '1 hour', date_labels = "%l %p")

```

# Rainfall metrics

## MRMS MI60

```{r mrms mi60}

load('rain_metrics.RData')

#manual for now
me <- mrms %>%
  filter(site == 'me',
         p_mmhr > 0) %>% 
  arrange(datetime)

#me
me <- get_setup(me, me$datetime) %>%
  group_by(event) %>%
  summarize(MI60 = max(p_mmhr),
            P = sum(p_mmhr),
             duration = max(datetime) - min(datetime),
             endtime = max(datetime),
            starttime = min(datetime)) %>%
  mutate(duration_hr = as.numeric(duration/60/60)) %>%
  filter(P > 1) %>%
  mutate(site = 'me')

#mm
mm <- mrms %>%
  filter(site == 'mm',
         p_mmhr > 0) %>% 
  arrange(datetime)

mm <- get_setup(mm, me$datetime) %>%
  group_by(event) %>%
  summarize(MI60 = max(p_mmhr),
            P = sum(p_mmhr),
             duration = max(datetime) - min(datetime),
             endtime = max(datetime),
            starttime = min(datetime)) %>%
  mutate(duration_hr = as.numeric(duration/60/60)) %>%
  filter(P > 1) %>%
  mutate(site = 'mm')

#mw
mw <- mrms %>%
  filter(site == 'mw',
         p_mmhr > 0) %>% 
  arrange(datetime)

mw <- get_setup(mw, mw$datetime) %>%
  group_by(event) %>%
  summarize(MI60 = max(p_mmhr),
            P = sum(p_mmhr),
             duration = max(datetime) - min(datetime),
             endtime = max(datetime),
            starttime = min(datetime)) %>%
  mutate(duration_hr = as.numeric(duration/60/60)) %>%
  filter(P > 1) %>%
  mutate(site = 'mw')

#ue
ue <- mrms %>%
  filter(site == 'ue',
         p_mmhr > 0) %>% 
  arrange(datetime)

ue <- get_setup(ue, ue$datetime) %>%
  group_by(event) %>%
  summarize(MI60 = max(p_mmhr),
            P = sum(p_mmhr),
             duration = max(datetime) - min(datetime),
             endtime = max(datetime),
            starttime = min(datetime)) %>%
  mutate(duration_hr = as.numeric(duration/60/60)) %>%
  filter(P > 1) %>%
  mutate(site = 'ue')

#um
um <- mrms %>%
  filter(site == 'um',
         p_mmhr > 0) %>% 
  arrange(datetime)

um <- get_setup(um, um$datetime) %>%
  group_by(event) %>%
  summarize(MI60 = max(p_mmhr),
            P = sum(p_mmhr),
             duration = max(datetime) - min(datetime),
             endtime = max(datetime),
            starttime = min(datetime)) %>%
  mutate(duration_hr = as.numeric(duration/60/60)) %>%
  filter(P > 1) %>%
  mutate(site = 'um')

#uw
uw <- mrms %>%
  filter(site == 'uw',
         p_mmhr > 0) %>% 
  arrange(datetime)
 
uw <- get_setup(uw, uw$datetime) %>%
  group_by(event) %>%
  summarize(MI60 = max(p_mmhr),
            P = sum(p_mmhr),
             duration = max(datetime) - min(datetime),
             endtime = max(datetime),
            starttime = min(datetime)) %>%
  mutate(duration_hr = as.numeric(duration/60/60)) %>%
  filter(P > 1) %>%
  mutate(site = 'uw')

mrms_metrics <- bind_rows(me, mm, mw, ue, um, uw)

#mrms rain metrics summary
#response summary
rain_summary <- mrms_metrics %>%
  ungroup() %>% 
  dplyr::select(c(site, P, MI60,
                  event)) %>%
  group_by(site) %>%
  summarize(Total_events = n(),
            Max_P_mm = max(P),
            Mean_P_mm = mean(P),
            Median_P_mm = median(P),
            Median_MI60 = median(MI60),
            Max_MI60 = max(MI60),
            Mean_MI60 = mean(MI60)) %>%
  mutate_if(is.numeric,
            round,
            digits = 2)

kable(rain_summary) %>%
  row_spec(0,bold=TRUE) %>% 
    kable_styling()

mrms_metrics %>%
ggplot(aes(site, MI60)) +
  geom_boxplot() +
  ggtitle('MRMS MI60') +
  labs(y = 'MI60 (mm/hr)')


### hydro days figs ###
mrms_metrics$color_var <- ifelse(substr(mrms_metrics$site, 1, 1) == "m", "Mulched", "Untreated")

mi60_boxplot <- mrms_metrics %>%
  ggplot(aes(site, MI60, fill = color_var)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("m_sites" = "coral3", "other_sites" = "white")) +
  scale_y_log10() +
  labs(x='Site', y = 'MI60 (mm/hr)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_hline(yintercept = 15.0368, color = 'grey', linetype= 'dashed') +
  geom_text(aes(x = 1.5, y = 16.5), label = "1-year RI") +
  geom_hline(yintercept = 17.907, color = 'grey', linetype= 'dashed') +
  geom_text(aes(x = 1.5, y = 19.5), label = "2-year RI") +
  geom_hline(yintercept = 23.3934, color = 'grey', linetype= 'dashed')+
  geom_text(aes(x = 1.5, y = 25.5), label = "5-year RI") 

mi60_boxplot

ggsave("MI60_boxplot.png", plot = mi60_boxplot, width = 8, height = 6, dpi = 300)

p_vio <- mrms_metrics %>%
  ggplot(aes(site, P, fill = color_var)) +
  geom_violin(color = 'black') +
  geom_boxplot(width = 0.1) +
  scale_fill_manual(name = '', values = c("Mulched" = "goldenrod3", "Untreated" = "white")) +
  scale_y_log10() +
  labs(x='Site', y = 'Rain per event (mm)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'bottom') 

p_vio

ggsave("P_boxplot.png", plot = p_vio, width = 8, height = 6, dpi = 300)

mi60_vio <- mrms_metrics %>%
  ggplot(aes(site, MI60, fill = color_var)) +
  geom_violin(color = "black") +
  geom_boxplot(width=0.1) +
  scale_fill_manual(name = '', values = c("Mulched" = "goldenrod3", "Untreated" = "white")) +
  scale_y_log10() +
  labs(x='Site', y = 'MI60 (mm/hr)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_hline(yintercept = 15.0368, color = 'grey', linetype= 'dashed') +
  geom_text(aes(x = 1.5, y = 16.5), label = "1-year RI") +
  geom_hline(yintercept = 17.907, color = 'grey', linetype= 'dashed') +
  geom_text(aes(x = 1.5, y = 19.5), label = "2-year RI") +
  geom_hline(yintercept = 23.3934, color = 'grey', linetype= 'dashed')+
  geom_text(aes(x = 1.5, y = 25.5), label = "5-year RI") 

ggsave("mi60_pvio.png", plot = mi60_vio, width = 8, height = 6, dpi = 300)

############

```

## Boxplots of TB & MRMS MI60s and total P

```{r compare MI60s}
#read in tb events
tb_mi60 <- read_csv("tb_events.csv") %>%
  mutate(source = 'tb',
         year = year(endtime)) %>% 
  dplyr::select(event, MI60, starttime, endtime, site = Site, duration_hr, P, source, year)

#get mrms mi60 and other rain metrics
mrms_metrics <- mrms_metrics %>%
  mutate(source = 'mrms',
         year = year(endtime)) %>%
  ungroup() %>%
  dplyr::select(event, MI60, starttime, endtime, site, duration_hr, P, source, year) 

comp_mi60 <- bind_rows(tb_mi60, mrms_metrics)

comp_mi60 %>%
ggplot(aes(x = source, y = MI60)) +
  geom_boxplot() +
  facet_wrap(~site) 

comp_mi60 %>%
ggplot(aes(x = source, y = P)) +
  geom_boxplot() +
  facet_wrap(~site) +
  labs( y = 'P (mm) per event')

comp_mi60 %>%
  group_by(site, source, year) %>% 
  summarize(totalP = sum(P)) %>%
  ggplot(aes(x = as.factor(year), y = totalP, color = source, shape = source)) +
  geom_point(size = 4) +
  facet_wrap(~site)
 
```

## 1:1 MRMS MI60 vs TB

```{r 1:1 mi60}

tb_mi60_comp <- tb_mi60 %>%
  mutate(starttime_floor = floor_date(starttime, unit = 'hour'),
         date = as.Date(starttime),
         doy = yday(date),
         code = paste0(site, doy))

mrms_mi60 <- mrms_metrics %>%
  rename(starttime_floor = starttime) %>%
  mutate(date = as.Date(starttime_floor),
         doy = yday(date),
         code = paste0(year,site,doy)) %>%
  mutate(dup = duplicated(code))

uno_v_uno <- left_join(mrms_mi60, tb_mi60_comp, by = c('site', 'starttime_floor'))

ggplot(uno_v_uno, aes(x=MI60.y, y = MI60.x)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  labs(x = 'TB MI60', y = 'MRMS MI60')


```

# MRMS response analyses

## MRMS response

```{r MRMS stage response, echo = F}

#get all stage data
load('stage.Rdata')

#tweak stage response function
get_radar_stage_resp <- function(events_df, stage_df) {
  
  response <- data.frame()
  
  for(i in 1:nrow(events_df)){
    temp <- stage_df %>%
      filter(datetime >=(events_df$starttime[i]) 
             & datetime <=(events_df$endtime[i] + 12*60*60))
    
    temp$event = ifelse(temp$datetime >=(events_df$starttime[i]) 
                        & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                        events_df$event[i])
    
    temp$duration_hr = ifelse(temp$datetime >=(events_df$starttime[i]) 
                              & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                              events_df$duration_hr[i])
    
    temp$P = ifelse(temp$datetime >=(events_df$starttime[i]) 
                    & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                    events_df$P[i])
    
    temp$MI60 = ifelse(temp$datetime >=(events_df$starttime[i]) 
                       & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                       events_df$MI60[i])
    
    temp$starttime = ifelse(temp$datetime >=(events_df$starttime[i]) 
                            & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                            events_df$starttime[i])
    
    temp$endtime = ifelse(temp$datetime >=(events_df$starttime[i]) 
                          & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                          events_df$endtime[i])
    
    response <- rbind(response, temp)
  }
  
  out <- response %>%
    group_by(event) %>%
    mutate(Stage_range = max(Stage_mm) - min(Stage_mm),
           bed_change_mm = last(Stage_mm) - first(Stage_mm)) %>%
    group_by(event) %>%
    filter(Stage_mm == max(Stage_mm)) %>%
    rename(Stage_mm_max = Stage_mm) %>% 
    group_by(event) %>%
    filter(datetime == max(datetime)) %>%
    rename(datetime_maxstage = datetime) %>%
    mutate(starttime_rain = as_datetime(starttime),
           endtime_rain = as_datetime(endtime),
           lag2p_hr = as.numeric(datetime_maxstage - starttime_rain)) %>%
    filter(!duration_hr == 0) %>%
    mutate(response = ifelse(Stage_range > 2, 1, 0)) %>% 
    dplyr::select(-c(starttime, endtime))
  
}


#break out mimrs_mi60 by site
me_events <- mrms_metrics %>%
  filter(site == 'me')

mm_events <- mrms_metrics %>%
  filter(site == 'mm')

mw_events <- mrms_metrics %>%
  filter(site == 'mw')

ue_events <- mrms_metrics %>%
  filter(site == 'ue')

um_events <- mrms_metrics %>%
  filter(site == 'um')

uw_events <- mrms_metrics %>%
  filter(site == 'uw')

#now get stage response for each site
me_response <- get_radar_stage_resp(me_events, me_stage)
mm_response <- get_radar_stage_resp(mm_events, mm_stage)
mw_response <- get_radar_stage_resp(mw_events, mw_stage)
ue_response <- get_radar_stage_resp(ue_events, ue_stage)
um_response <- get_radar_stage_resp(um_events, um_stage) 
uw_response <- get_radar_stage_resp(uw_events, uw_stage)

mrms_response <- bind_rows(me_response, mm_response,
                           mw_response, ue_response,
                           um_response, uw_response)


ggplot(mrms_response, aes(site, Stage_range)) +
  geom_boxplot()

#response summary
response_summary <- mrms_response %>%
  ungroup() %>% 
  dplyr::select(c(site, P, MI60,
                  Stage_mm_max, Stage_range, bed_change_mm, lag2p_hr, response)) %>%
  group_by(site) %>%
  summarize(Total_events = n(),
            Max_Stage_Response_cm = max(Stage_range/10),
            Mean_Stage_response_cm = mean(Stage_range/10),
            Median_stage = median(Stage_range/10),
            max_bed = max(bed_change_mm/10),
            median_bed = median(bed_change_mm/10)) %>%
  mutate_if(is.numeric,
            round,
            digits = 2)

kable(response_summary) %>%
  kable_styling()

#note, stage is mm

### hydro days figs ###

library(ggallin)

mrms_response$color_var <- ifelse(substr(mrms_response$site, 1, 1) == "m", "Mulched", "Untreated")

response_bplot <- mrms_response %>%
  ggplot(aes(site, Stage_range/10, fill = color_var)) +
  geom_violin(color = 'black') +
  geom_boxplot(color = "black", width = 0.05) +
  scale_fill_manual(name = '', values = c("Mulched" = "goldenrod3", "Untreated" = "white")) +
  scale_y_continuous(trans = pseudolog10_trans) +
  #scale_y_log10() +
  labs(x='Site', y = 'Stage rise (cm)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) 

response_bplot

ggsave("stage_boxplot.png", plot = response_bplot, width = 8, height = 6, dpi = 300)

mrms_response <- mrms_response %>%
  mutate(response_char = if_else(response == 1, 'Yes', 'No'),
         response_big = if_else(Stage_range > 100, '>10', '<10'))

mrms_response$color_var <- ifelse(substr(mrms_response$site, 1, 1) == "m", "Mulched", "Untreated")
library(gghighlight)

site_names <- c('me' = 'Mulched east', 
                'mm' = 'Mulched middle', 
                'mw' = 'Mulched west',
                'ue' = 'Unmulched east',
                'um' = 'Unmulched middle',
                'uw' = 'Unmulched west')

comp3 <- mrms_response %>%
  ggplot(aes(MI60, Stage_range/10, color = response_char, shape = response_char, alpha = response_char)) +
  geom_point(size = 3) +
  scale_color_manual(name = 'Response', values = c("No" = "black", "Yes" = "deepskyblue4")) +
  scale_alpha_manual(name = 'Response', values = c('No' = 1, 'Yes' = 0.5)) +
  scale_shape_manual(name = 'Response', values = c('No' = 19, 'Yes' = 17)) +
  scale_y_continuous(trans = pseudolog10_trans, limits = c(0,110)) +
  labs(x='MI60 (mm/hr)', y = 'Stage rise (cm)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "right")  +
  facet_wrap(~site,
             labeller = as_labeller(site_names)) +
  geom_hline(yintercept = 10)

comp3

ggsave("compare.png", plot = comp3, width = 8, height = 6, dpi = 300)

### density
  ggplot(mrms_response, aes(Stage_range/10)) +
  geom_density() +
  facet_wrap(~site,
             labeller = as_labeller(site_names)) 

bedchange_bplot <- mrms_response %>%
  ggplot(aes(site, bed_change_mm/10, fill = color_var)) +
  geom_violin(color = 'black') +
  geom_boxplot(color = "black", width = 0.1) +
  scale_fill_manual(values = c("m_sites" = "goldenrod3", "other_sites" = "white")) +
  #scale_y_log10() +
  labs(x='Site', y = 'Bed change (cm)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) 

bedchange_bplot

ggsave("bedchange_boxplot.png", plot = bedchange_bplot, width = 8, height = 6, dpi = 300)

bedchange_bplot <- mrms_response %>%
  ggplot(aes(site, bed_change_mm/10, fill = color_var)) +
    geom_hline(yintercept = 0, color = 'black') +
  geom_violin(color = 'black') +
  geom_boxplot(color = "black", width = 0.1) +
  scale_fill_manual(name = '', values = c("Mulched" = "goldenrod3", "Untreated" = "white")) +
  scale_y_continuous(trans = pseudolog10_trans, limits = c(-20,70)) +
    #scale_y_log10() +
  labs(x='Site', y = 'Bed change (cm)') +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_text(aes(x = 5, y = 25.5), label = "Aggradation") +
  geom_text(aes(x = 5, y = -10), label = "Degradation")

bedchange_bplot

ggsave("bedchange_boxplot.png", plot = bedchange_bplot, width = 8, height = 6, dpi = 300)

##################

```

## MRMS correlations

```{r cor}

# me correlations
me_cor <- me_response %>%
  ungroup() %>% 
  dplyr::select(duration_hr, P, MI60, bed_change_mm) %>%
  cor()

me_cor

# mm correlations
mm_cor <- mm_response %>%
  ungroup() %>% 
  dplyr::select(duration_hr, P, MI60) %>%
  cor()
mm_cor

# mw correlations
mw_cor <- mw_response %>%
  ungroup() %>% 
  dplyr::select(duration_hr, P, MI60) %>%
  cor()

mw_cor

# ue correlations
ue_cor <- ue_response %>%
  ungroup() %>% 
  dplyr::select(duration_hr, P, MI60) %>%
  cor()
ue_cor

# um correlations
um_cor <- um_response %>%
  ungroup() %>% 
  dplyr::select(duration_hr, P, MI60) %>%
  cor()
um_cor

# uw correlations
uw_cor <- uw_response %>%
  ungroup() %>% 
  dplyr::select(duration_hr, P, MI60) %>%
  cor()
uw_cor

```

## MRMS logistic regressions

```{r}

ben_q <- read_csv('/Users/megansears/Documents/Repos/CPF/bennett/larimerco_bennett_Q.csv') %>%
  rename(datetime = DateTime) %>%
  mutate(datetime = ymd_hm(datetime)) %>% 
  mutate(q_cms = q_cfs*0.028)

ben_q <- ben_q %>%
  rename(floor_dt = datetime) %>%
  mutate(floor_dt = floor_date(floor_dt, 'hour')) %>%
  group_by(floor_dt) %>%
  summarize(q_cms = mean(q_cms))


#me 
me_response2 <- me_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
me_response2 <- left_join(me_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

me_glm <- glm(response ~ q_cms + doy +P + duration_hr + MI60, data = me_response2, family = binomial)

me_response2$pred <- predict(me_glm, me_response2, type = 'response')

me_response3 <- me_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction) 

me_kappa <- kappa2(me_response3)
me_kappa$value

me_cm <- confusionMatrix(as.factor(me_response3$prediction), as.factor(me_response3$response))
me_cm

#mm
mm_response2 <- mm_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
mm_response2 <- left_join(mm_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

mm_glm <- glm(response ~ q_cms + doy + duration_hr + P + MI60, data = mm_response2, family = binomial)

mm_response2$pred <- predict(mm_glm, mm_response2, type = 'response')

mm_response3 <- mm_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction)

mm_kappa <- kappa2(mm_response3)
mm_kappa$value

mm_cm <- confusionMatrix(as.factor(mm_response3$prediction), as.factor(mm_response3$response))
mm_cm


#mw
mw_response2 <- mw_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
mw_response2 <- left_join(mw_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

mw_glm <- glm(response ~ q_cms + doy + duration_hr + MI60 + P, data = mw_response2, family = binomial)

mw_response2$pred <- predict(mw_glm, mw_response2, type = 'response')

mw_response3 <- mw_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction)

mw_kappa <- kappa2(mw_response3)
mw_kappa$value

mw_cm <- confusionMatrix(as.factor(mw_response3$prediction), as.factor(mw_response3$response))
mw_cm


#ue
ue_response2 <- ue_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
ue_response2 <- left_join(ue_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

ue_glm <- glm(response ~ q_cms + doy + duration_hr + MI60 + P, data = ue_response2, family = binomial)

ue_response2$pred <- predict(ue_glm, ue_response2, type = 'response')

ue_response3 <- ue_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction)

ue_kappa <- kappa2(ue_response3)
ue_kappa$value

ue_cm <- confusionMatrix(as.factor(ue_response3$prediction), as.factor(ue_response3$response))
ue_cm

#um
um_response2 <- um_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
um_response2 <- left_join(um_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

um_glm <- glm(response ~ q_cms + doy + duration_hr + MI60 + P, data = um_response2, family = binomial)

um_response2$pred <- predict(um_glm, um_response2, type = 'response')

um_response3 <- um_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction)

um_kappa <- kappa2(um_response3)
um_kappa$value

um_cm <- confusionMatrix(as.factor(um_response3$prediction), as.factor(um_response3$response))
um_cm

#uw
uw_response2 <- uw_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
uw_response2 <- left_join(uw_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

uw_response2 <- uw_response2 %>%
  mutate(MI60_log = log(MI60 + 1))


uw_glm <- glm(response ~ q_cms + doy + duration_hr + P + MI60, data = uw_response2, family = binomial)
summary(uw_glm)

uw_response2$pred <- predict(uw_glm, uw_response2, type = 'response')

uw_response3 <- uw_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction)

uw_kappa <- kappa2(uw_response3)
uw_kappa$value

uw_cm <- confusionMatrix(as.factor(uw_response3$prediction), as.factor(uw_response3$response))
uw_cm


################
library(psych)
describe(uw_response2$q_cms)


# Compute confusion matrix and performance metrics
uw_rf_cm <- confusionMatrix(as.factor(uw_response3$prediction), as.factor(uw_response3$response))
uw_rf_cm


## make a df for this
first <- c('me', 'mm', 'mw',
           'ue', 'um', 'uw')
second <- c(me_kappa$value, mm_kappa$value, mw_kappa$value,
            ue_kappa$value, um_kappa$value, uw_kappa$value)

log_kappas <- data.frame(first,second) %>%
  rename(site = first,
         kappa = second)

kable(log_kappas) %>%
  kable_styling()



```

# MRMS linear multiple regression

```{r stage rise as response}


me_glm <- lm(Stage_range ~ q_cms + doy +P + duration_hr + MI60, data = me_response2)

summary(me_glm)
summary(me_glm)$r.squared


mm_glm <- lm(Stage_range ~ q_cms + doy +P + duration_hr + MI60, data = mm_response2)

summary(mm_glm)
summary(mm_glm)$r.squared

mw_glm <- lm(Stage_range ~ q_cms + doy +P + duration_hr + MI60, data = mw_response2)

summary(mw_glm)
summary(mw_glm)$r.squared

ue_glm <- lm(Stage_range ~ q_cms + doy +P + duration_hr + MI60, data = ue_response2)

summary(ue_glm)
summary(ue_glm)$r.squared

um_glm <- lm(Stage_range ~ q_cms + doy +P + duration_hr + MI60, data = um_response2)

summary(um_glm)
summary(um_glm)$r.squared

uw_glm <- lm(Stage_range ~ q_cms + doy +P + duration_hr + MI60, data = uw_response2)

summary(uw_glm)
summary(uw_glm)$r.squared


```

## MRMS logistic regressions with 10 cutoff

```{r logit regress with 10cm}

me_response10 <- me_response2 %>%
  mutate(response10 = ifelse(Stage_range > 100, 1, 0))

me_glm <- glm(response10 ~ q_cms + doy +P + duration_hr + MI60, data = me_response10, family = binomial)

me_response10$pred <- predict(me_glm, me_response10, type = 'response')

me_response_log10 <- me_response10 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction) 

me_kappa <- kappa2(me_response_log10)
me_kappa$value

me_cm <- confusionMatrix(as.factor(me_response_log10$prediction), as.factor(me_response_log10$response))
me_cm

###

mm_response10 <- mm_response2 %>%
  mutate(response10 = ifelse(Stage_range > 100, 1, 0))

mm_glm <- glm(response10 ~ q_cms + doy +P + duration_hr + MI60, data = mm_response10, family = binomial)

mm_response10$pred <- predict(mm_glm, mm_response10, type = 'response')

mm_response_log10 <- mm_response10 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction) 

mm_kappa <- kappa2(mm_response_log10)
mm_kappa$value

mm_cm <- confusionMatrix(as.factor(mm_response_log10$prediction), as.factor(mm_response_log10$response))
mm_cm

###

mw_response10 <- mw_response2 %>%
  mutate(response10 = ifelse(Stage_range > 100, 1, 0))

mw_glm <- glm(response10 ~ q_cms + doy +P + duration_hr + MI60, data = mw_response10, family = binomial)

mw_response10$pred <- predict(mw_glm, mw_response10, type = 'response')

mw_response_log10 <- mw_response10 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction) 

mw_kappa <- kappa2(mw_response_log10)
mw_kappa$value

mw_cm <- confusionMatrix(as.factor(mw_response_log10$prediction), as.factor(mw_response_log10$response))
mw_cm

###

ue_response10 <- ue_response2 %>%
  mutate(response10 = ifelse(Stage_range > 100, 1, 0))

ue_glm <- glm(response10 ~ q_cms + doy +P + duration_hr + MI60, data = ue_response10, family = binomial)

ue_response10$pred <- predict(ue_glm, ue_response10, type = 'response')

ue_response_log10 <- ue_response10 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction) 

ue_kappa <- kappa2(ue_response_log10)
ue_kappa$value

ue_cm <- confusionMatrix(as.factor(ue_response_log10$prediction), as.factor(ue_response_log10$response))
ue_cm

###

uw_response10 <- uw_response2 %>%
  mutate(response10 = ifelse(Stage_range > 100, 1, 0))

uw_glm <- glm(response10 ~ q_cms + doy +P + duration_hr + MI60, data = uw_response10, family = binomial)

uw_response10$pred <- predict(uw_glm, uw_response10, type = 'response')

uw_response_log10 <- uw_response10 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  dplyr::select(response, prediction) 

uw_kappa <- kappa2(uw_response_log10)
uw_kappa$value

uw_cm <- confusionMatrix(as.factor(uw_response_log10$prediction), as.factor(uw_response_log10$response))
uw_cm

###

```


```{r}
library(nlme)

test_mixed <- lme(response ~ MI60, random = (~1|site), na.action = na.omit, data = mrms_response)
summary(test_mixed)


```


